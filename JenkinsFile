pipeline {
  agent any
  options { timestamps() }   // ← ansiColor retiré

  environment {
    KRE = 'C:\\Katalon\\katalon.exe'   // adapte si besoin
  }

  stages {
    stage('Checkout Katalon Project') {
      steps { checkout scm }
    }

    stage('Start WinAppDriver (Desktop)') {
      steps {
        bat 'tasklist | find "WinAppDriver.exe" || start /B "" "C:\\Program Files (x86)\\Windows Application Driver\\WinAppDriver.exe"'
        bat 'ping -n 3 127.0.0.1 > nul'
      }
    }

    stage('Run Katalon Suite') {
      steps {
        withCredentials([string(credentialsId: 'katalon_api_key', variable: 'KATALON_API_KEY')]) {
          bat """
            "%KRE%" -noSplash -runMode=console ^
              -projectPath="%WORKSPACE%\\sample-windows-application-test-master\\sample-windows-application-test.prj" ^
              -retry=0 -retryFailedTestCases=false ^
              -testSuitePath="Test Suites/Smoke" ^
              -executionProfile="default" ^
              -apiKey="%KATALON_API_KEY%" ^
              -reportFolder="Reports" -reportFileName="desktop_smoke"
          """
        }
      }
    }

    stage('Publish Reports') {
      steps {
        junit allowEmptyResults: true, testResults: '**/Reports/**/*.xml'
        archiveArtifacts artifacts: '**/Reports/**', fingerprint: true
      }
    }
  }

  post {
    always { echo 'Fin de job' }
  }
}
